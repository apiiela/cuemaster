<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cuepoints ‚Äî Full App</title>
  <style>
    :root{--bg:#0b0c10;--panel:#0f1117;--muted:#9aa3af;--text:#e6e8eb;--accent:#5b8cff;--ok:#22c55e}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;color:var(--text);background:linear-gradient(180deg,#07070a,#0b0c10)}
    .app{max-width:1100px;margin:28px auto;padding:20px;position:relative}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    h1{margin:0;font-size:1.2rem}
    .lead{margin:6px 0 0;color:var(--muted)}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));border:1px solid rgba(255,255,255,0.03);padding:14px;border-radius:12px}
    .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    button{background:transparent;border:1px solid #222;padding:8px 10px;border-radius:8px;color:var(--text);cursor:pointer}
    button.primary{background:var(--accent);border:none;color:#051025}
    input[type=file]{display:none}
    .drop{border:2px dashed rgba(255,255,255,0.03);padding:18px;border-radius:10px;text-align:center;color:var(--muted);margin-bottom:12px;cursor:pointer}
    canvas{width:100%;height:140px;border-radius:8px;background:#051019;display:block;cursor:pointer}
    .time{font-variant-numeric:tabular-nums;color:var(--muted);min-width:110px;text-align:center;padding:6px;border-radius:8px;font-size:1.5rem;font-weight:bold}
    .cue-list{margin-top:12px;border-radius:10px;overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.02)}
    .swatch{width:18px;height:18px;border-radius:4px;display:inline-block;margin-right:8px;vertical-align:middle}
    .small{font-size:.9rem;color:var(--muted)}
    .kbd{border:1px solid rgba(255,255,255,0.06);padding:4px 6px;border-radius:6px;background:rgba(255,255,255,0.01)}
    .muted{color:var(--muted)}
    @media (max-width:800px){.cols{flex-direction:column}}
    .cols{display:flex;gap:12px}
    .col{flex:1}
    .notes{width:100%;min-width:120px}
    .flash{color:var(--ok)}
    .cue-banner{position:absolute;padding:6px 10px;border-radius:6px;font-size:0.9rem;white-space:nowrap;pointer-events:none;display:none;color:#fff;opacity:0;transform:translate(-50%,-120%) scale(0.95);transition:opacity 0.2s ease, transform 0.2s ease;}
    .cue-banner.show{display:block;opacity:1;transform:translate(-50%,-140%) scale(1);}
    .playlist{margin:12px 0;display:flex;gap:6px;flex-wrap:wrap}
    .page-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:6px;border:1px solid #333;cursor:pointer;position:relative}
    .page-label{flex:1;}
    .rename-input{position:absolute;top:0;left:0;width:100%;height:100%;border:none;border-radius:6px;padding:4px;text-align:center;font-size:0.9rem;z-index:2}
    .remove-btn{background:transparent;border:none;color:#eee;cursor:pointer;font-size:0.8rem;padding:0 4px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Cuepoints ‚Äî Full App</h1>
        <div class="lead">Import audio, add/edit cue points, save/load sessions. Timecode flashes green when a cue triggers.</div>
      </div>
      <div style="text-align:right">
        <div class="small">Shortcuts: <span class="kbd">Space</span>=Play, <span class="kbd">C</span>=Add cue, <span class="kbd">‚Üê/‚Üí</span>=Seek 5s, <span class="kbd">[</span>/<span class="kbd">]</span>=Frame step</div>
      </div>
    </header>

    <div class="playlist" id="playlist"></div>
    <button id="newPageBtn">Ôºã New Page</button>

    <div class="panel">
      <label class="drop" id="dropZone">Drop audio file here or click to select<input type="file" id="fileInput" accept="audio/*" /></label>
      <div class="controls">
        <button id="playBtn">‚ñ∂Ô∏é</button>
        <button id="pauseBtn">‚ùö‚ùö</button>
        <button id="stopBtn">‚èπ Restart</button>
        <button id="addCueBtn">Ôºã Cue</button>
        <button id="saveBtn">üíæ Save</button>
        <button id="openBtn">üìÇ Open</button>
        <span class="time" id="timeDisplay">00:00.000</span>
      </div>
      <canvas id="waveform"></canvas>
      <div class="cue-list">
        <table>
          <thead>
            <tr><th>Time</th><th>Name</th><th>Note</th><th>Colour</th><th>Actions</th></tr>
          </thead>
          <tbody id="cueTableBody"></tbody>
        </table>
      </div>
    </div>
    <div class="cue-banner" id="cueBanner"></div>
  </div>

  <audio id="audioEl" crossorigin="anonymous" hidden></audio>

  <script>
    const playlistEl=document.getElementById('playlist');
    const newPageBtn=document.getElementById('newPageBtn');
    const audioEl=document.getElementById('audioEl');
    const playBtn=document.getElementById('playBtn');
    const pauseBtn=document.getElementById('pauseBtn');
    const stopBtn=document.getElementById('stopBtn');
    const addCueBtn=document.getElementById('addCueBtn');
    const saveBtn=document.getElementById('saveBtn');
    const openBtn=document.getElementById('openBtn');
    const fileInput=document.getElementById('fileInput');
    const dropZone=document.getElementById('dropZone');
    const timeDisplay=document.getElementById('timeDisplay');
    const cueTableBody=document.getElementById('cueTableBody');
    const cueBanner=document.getElementById('cueBanner');
    const canvas=document.getElementById('waveform');
    const ctx=canvas.getContext('2d');

    let pages=[];let currentPage=0;

    function addPage(name="Page", color="#333"){
      pages.push({name, color, cues: []});
      currentPage=pages.length-1;
      renderPages();
      loadPage();
    }

    newPageBtn.addEventListener('click',()=>addPage("Page "+(pages.length+1)));

    function renderPages(){
      playlistEl.innerHTML='';
      pages.forEach((p,i)=>{
        const btn=document.createElement('div');
        btn.className='page-btn';
        btn.style.background=p.color||'#333';

        const label=document.createElement('span');
        label.textContent=p.name;
        label.className='page-label';

        btn.addEventListener('click',()=>{currentPage=i;loadPage();drawWaveform();});

        label.addEventListener('dblclick',(ev)=>{
          ev.stopPropagation();
          const input=document.createElement('input');
          input.value=p.name;
          input.className='rename-input';
          btn.innerHTML='';
          btn.appendChild(input);
          input.focus();
          input.select();
          input.addEventListener('blur',()=>{p.name=input.value||p.name;renderPages();});
          input.addEventListener('keydown',(ev)=>{if(ev.key==='Enter'){p.name=input.value||p.name;renderPages();}});
        });

        const rm=document.createElement('button');
        rm.textContent='‚úï';
        rm.className='remove-btn';
        rm.addEventListener('click',(ev)=>{
          ev.stopPropagation();
          if(confirm('Remove page "'+p.name+'"?')){
            pages.splice(i,1);
            if(currentPage>=pages.length)currentPage=Math.max(0,pages.length-1);
            renderPages();
            loadPage();
            drawWaveform();
          }
        });

        btn.appendChild(label);
        btn.appendChild(rm);
        playlistEl.appendChild(btn);
      });
    }

    function loadPage(){
      cueTableBody.innerHTML='';
      if(!pages[currentPage])return;
      pages[currentPage].cues.forEach((cue,j)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${cue.time}</td>
                      <td><input value="${cue.name||''}" data-field="name" data-i="${j}"/></td>
                      <td><input class="notes" value="${cue.note||''}" data-field="note" data-i="${j}"/></td>
                      <td><input type="color" value="${cue.color||'#5b8cff'}" data-field="color" data-i="${j}"/></td>
                      <td><button data-i="${j}" class="del">Delete</button></td>`;
        tr.querySelectorAll('input').forEach(inp=>{
          inp.addEventListener('input',()=>{
            const field=inp.dataset.field;
            pages[currentPage].cues[j][field]=inp.value;
            drawWaveform();
          });
        });
        tr.querySelector('.del').addEventListener('click',()=>{
          pages[currentPage].cues.splice(j,1);
          loadPage();
          drawWaveform();
        });
        cueTableBody.appendChild(tr);
      });
    }

    // Add Cue
    addCueBtn.addEventListener('click',()=>{
      if(!pages[currentPage])return;
      const t=audioEl.currentTime||0;
      const ms=(t%1).toFixed(3).substring(2);
      const s=('0'+Math.floor(t%60)).slice(-2);
      const m=('0'+Math.floor(t/60)).slice(-2);
      const timeStr=`${m}:${s}.${ms}`;
      pages[currentPage].cues.push({time:timeStr,name:'',note:'',color:'#5b8cff'});
      loadPage();
      drawWaveform();
    });

    // File import
    dropZone.addEventListener('click',()=>fileInput.click());
    dropZone.addEventListener('dragover',(e)=>{e.preventDefault();});
    dropZone.addEventListener('drop',(e)=>{
      e.preventDefault();
      if(e.dataTransfer.files.length) loadFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change',()=>{
      if(fileInput.files.length) loadFile(fileInput.files[0]);
    });

    function loadFile(file){
      const url=URL.createObjectURL(file);
      audioEl.src=url;
      audioEl.load();
    }

    // Save/Load
    saveBtn.addEventListener('click',()=>{
      const blob=new Blob([JSON.stringify(pages)],{type:'application/json'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='cuepoints.json';
      a.click();
    });

    openBtn.addEventListener('click',()=>{
      const inp=document.createElement('input');
      inp.type='file';
      inp.accept='.json';
      inp.addEventListener('change',()=>{
        if(inp.files.length){
          const fr=new FileReader();
          fr.onload=()=>{
            pages=JSON.parse(fr.result);
            currentPage=0;
            renderPages();
            loadPage();
            drawWaveform();
          };
          fr.readAsText(inp.files[0]);
        }
      });
      inp.click();
    });

    // Audio controls
    playBtn.addEventListener('click',()=>audioEl.play());
    pauseBtn.addEventListener('click',()=>audioEl.pause());
    stopBtn.addEventListener('click',()=>{if(isFinite(audioEl.duration)){audioEl.currentTime=0;}audioEl.pause();});

    audioEl.addEventListener('timeupdate',()=>{
      const t=audioEl.currentTime;
      const ms=(t%1).toFixed(3).substring(2);
      const s=('0'+Math.floor(t%60)).slice(-2);
      const m=('0'+Math.floor(t/60)).slice(-2);
      timeDisplay.textContent=`${m}:${s}.${ms}`;

      if(pages[currentPage]){
        pages[currentPage].cues.forEach(cue=>{
          const [cm,cs]=cue.time.split(':');
          const [sec,millis]=cs.split('.');
          const cueTime=parseInt(cm)*60+parseInt(sec)+parseInt(millis)/1000;
          if(Math.abs(cueTime-t)<0.1){
            timeDisplay.classList.add('flash');
            setTimeout(()=>timeDisplay.classList.remove('flash'),200);
          }
        });
      }
    });

    // Draw waveform markers
    function drawWaveform(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle='#051019';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      if(!pages[currentPage]||!isFinite(audioEl.duration)) return;
      pages[currentPage].cues.forEach(cue=>{
        const [cm,cs]=cue.time.split(':');
        const [sec,millis]=cs.split('.');
        const cueTime=parseInt(cm)*60+parseInt(sec)+parseInt(millis)/1000;
        const x=(cueTime/audioEl.duration)*canvas.width;
        ctx.fillStyle=cue.color||'#5b8cff';
        ctx.fillRect(x-2,0,4,canvas.height);
      });
    }

    // Hover detection on markers
    canvas.addEventListener('mousemove',(e)=>{
      if(!pages[currentPage]||!isFinite(audioEl.duration)) return;
      const rect=canvas.getBoundingClientRect();
      const x=e.clientX-rect.left;
      const cues=pages[currentPage].cues;
      let found=null;
      cues.forEach(cue=>{
        const [cm,cs]=cue.time.split(':');
        const [sec,millis]=cs.split('.');
        const cueTime=parseInt(cm)*60+parseInt(sec)+parseInt(millis)/1000;
        const cx=(cueTime/audioEl.duration)*canvas.width;
        if(Math.abs(x-cx)<5) found={cue,cx};
      });

      if(found){
        cueBanner.textContent=found.cue.name||'(unnamed)';
        cueBanner.style.background=found.cue.color;
        cueBanner.style.left=(rect.left+found.cx)+'px';
        cueBanner.style.top=(rect.top)+'px';
        cueBanner.classList.add('show');
      } else {
        cueBanner.classList.remove('show');
      }
    });

    canvas.addEventListener('mouseleave',()=>{
      cueBanner.classList.remove('show');
    });

    // Init
    addPage("Page 1");
    audioEl.addEventListener('loadedmetadata',drawWaveform);
  </script>
</body>
</html>
